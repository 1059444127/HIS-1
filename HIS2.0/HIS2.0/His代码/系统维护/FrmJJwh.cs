using System;
using System.Drawing;
using System.Collections;
using System.ComponentModel;
using System.Windows.Forms;
using System.Data;
using TrasenFrame.Classes;
using TrasenClasses.GeneralControls;
using TrasenClasses.GeneralClasses;
using YpClass;
namespace ts_yp_xtwh
{
	/// <summary>
	/// Form1 的摘要说明。
	/// </summary>
	public class FrmJJwh : System.Windows.Forms.Form
	{
		private System.Windows.Forms.StatusBar statusBar1;
		private System.Windows.Forms.StatusBarPanel statusBarPanel1;
		private System.Windows.Forms.StatusBarPanel statusBarPanel2;
		private myDataGrid.myDataGrid myDataGrid1;
		private System.Windows.Forms.DataGridTableStyle dataGridTableStyle1;
		private System.Windows.Forms.DataGridTextBoxColumn dataGridTextBoxColumn1;
		private System.Windows.Forms.DataGridTextBoxColumn dataGridTextBoxColumn2;
		private System.Windows.Forms.DataGridTextBoxColumn dataGridTextBoxColumn3;
		private System.Windows.Forms.DataGridTextBoxColumn dataGridTextBoxColumn4;
		private System.Windows.Forms.DataGridTextBoxColumn dataGridTextBoxColumn5;
		private System.Windows.Forms.DataGridTextBoxColumn dataGridTextBoxColumn6;
		private System.Windows.Forms.DataGridTextBoxColumn dataGridTextBoxColumn7;
		private System.Windows.Forms.DataGridTextBoxColumn dataGridTextBoxColumn8;
		private System.Windows.Forms.Label label1;
		private System.Windows.Forms.TextBox txtdm;
		private System.Windows.Forms.Button butsave;
		private MenuTag _menuTag;
		private string _chineseName;
		private Form _mdiParent;
		private System.Windows.Forms.Panel panel1;
		private System.Windows.Forms.ComboBox cmbyplx;
		private System.Windows.Forms.ComboBox cmbjx;
		private System.Windows.Forms.CheckBox chkjx;
		private System.Windows.Forms.CheckBox chkkcl;
		private System.Windows.Forms.Button button1;
		private System.Windows.Forms.Panel panel2;
		private System.Windows.Forms.CheckBox chkjj;
		private System.Windows.Forms.DataGridTextBoxColumn dataGridTextBoxColumn9;
		private System.Windows.Forms.DataGridTextBoxColumn dataGridTextBoxColumn10;
		private System.Windows.Forms.Button butcx;
		private System.Windows.Forms.Label label2;
		private System.Windows.Forms.DataGridTextBoxColumn dataGridTextBoxColumn11;
		private System.Windows.Forms.DataGridTextBoxColumn dataGridTextBoxColumn12;
		private System.Windows.Forms.DataGridTextBoxColumn dataGridTextBoxColumn13;

		/// <summary>
		/// 必需的设计器变量。
		/// </summary>
		private System.ComponentModel.Container components = null;

		public FrmJJwh(MenuTag menuTag,string chineseName,Form mdiParent)
		{
			//
			// Windows 窗体设计器支持所必需的
			//
			InitializeComponent();
			_menuTag=menuTag;
			_chineseName=chineseName;
			_mdiParent=mdiParent;
			this.Text=_chineseName;

			//
			// TODO: 在 InitializeComponent 调用后添加任何构造函数代码
			//
		}

		/// <summary>
		/// 清理所有正在使用的资源。
		/// </summary>
		protected override void Dispose( bool disposing )
		{
			if( disposing )
			{
				if (components != null) 
				{
					components.Dispose();
				}
			}
			base.Dispose( disposing );
		}

		#region Windows 窗体设计器生成的代码
		/// <summary>
		/// 设计器支持所需的方法 - 不要使用代码编辑器修改
		/// 此方法的内容。
		/// </summary>
		private void InitializeComponent()
		{
			this.statusBar1 = new System.Windows.Forms.StatusBar();
			this.statusBarPanel1 = new System.Windows.Forms.StatusBarPanel();
			this.statusBarPanel2 = new System.Windows.Forms.StatusBarPanel();
			this.myDataGrid1 = new myDataGrid.myDataGrid();
			this.dataGridTableStyle1 = new System.Windows.Forms.DataGridTableStyle();
			this.dataGridTextBoxColumn1 = new System.Windows.Forms.DataGridTextBoxColumn();
			this.dataGridTextBoxColumn4 = new System.Windows.Forms.DataGridTextBoxColumn();
			this.dataGridTextBoxColumn2 = new System.Windows.Forms.DataGridTextBoxColumn();
			this.dataGridTextBoxColumn3 = new System.Windows.Forms.DataGridTextBoxColumn();
			this.dataGridTextBoxColumn5 = new System.Windows.Forms.DataGridTextBoxColumn();
			this.dataGridTextBoxColumn13 = new System.Windows.Forms.DataGridTextBoxColumn();
			this.dataGridTextBoxColumn6 = new System.Windows.Forms.DataGridTextBoxColumn();
			this.dataGridTextBoxColumn7 = new System.Windows.Forms.DataGridTextBoxColumn();
			this.dataGridTextBoxColumn8 = new System.Windows.Forms.DataGridTextBoxColumn();
			this.dataGridTextBoxColumn9 = new System.Windows.Forms.DataGridTextBoxColumn();
			this.dataGridTextBoxColumn10 = new System.Windows.Forms.DataGridTextBoxColumn();
			this.dataGridTextBoxColumn11 = new System.Windows.Forms.DataGridTextBoxColumn();
			this.dataGridTextBoxColumn12 = new System.Windows.Forms.DataGridTextBoxColumn();
			this.butsave = new System.Windows.Forms.Button();
			this.txtdm = new System.Windows.Forms.TextBox();
			this.label1 = new System.Windows.Forms.Label();
			this.panel1 = new System.Windows.Forms.Panel();
			this.butcx = new System.Windows.Forms.Button();
			this.button1 = new System.Windows.Forms.Button();
			this.chkjj = new System.Windows.Forms.CheckBox();
			this.chkkcl = new System.Windows.Forms.CheckBox();
			this.cmbyplx = new System.Windows.Forms.ComboBox();
			this.cmbjx = new System.Windows.Forms.ComboBox();
			this.chkjx = new System.Windows.Forms.CheckBox();
			this.label2 = new System.Windows.Forms.Label();
			this.panel2 = new System.Windows.Forms.Panel();
			((System.ComponentModel.ISupportInitialize)(this.statusBarPanel1)).BeginInit();
			((System.ComponentModel.ISupportInitialize)(this.statusBarPanel2)).BeginInit();
			((System.ComponentModel.ISupportInitialize)(this.myDataGrid1)).BeginInit();
			this.panel1.SuspendLayout();
			this.panel2.SuspendLayout();
			this.SuspendLayout();
			// 
			// statusBar1
			// 
			this.statusBar1.Location = new System.Drawing.Point(0, 461);
			this.statusBar1.Name = "statusBar1";
			this.statusBar1.Panels.AddRange(new System.Windows.Forms.StatusBarPanel[] {
																						  this.statusBarPanel1,
																						  this.statusBarPanel2});
			this.statusBar1.ShowPanels = true;
			this.statusBar1.Size = new System.Drawing.Size(768, 24);
			this.statusBar1.TabIndex = 0;
			this.statusBar1.Text = "statusBar1";
			// 
			// statusBarPanel1
			// 
			this.statusBarPanel1.Width = 300;
			// 
			// statusBarPanel2
			// 
			this.statusBarPanel2.Width = 1001;
			// 
			// myDataGrid1
			// 
			this.myDataGrid1.BackgroundColor = System.Drawing.Color.White;
			this.myDataGrid1.CaptionVisible = false;
			this.myDataGrid1.DataMember = "";
			this.myDataGrid1.Dock = System.Windows.Forms.DockStyle.Fill;
			this.myDataGrid1.HeaderForeColor = System.Drawing.SystemColors.ControlText;
			this.myDataGrid1.Location = new System.Drawing.Point(0, 0);
			this.myDataGrid1.Name = "myDataGrid1";
			this.myDataGrid1.Size = new System.Drawing.Size(768, 389);
			this.myDataGrid1.TabIndex = 0;
			this.myDataGrid1.TableStyles.AddRange(new System.Windows.Forms.DataGridTableStyle[] {
																									this.dataGridTableStyle1});
			// 
			// dataGridTableStyle1
			// 
			this.dataGridTableStyle1.AllowSorting = false;
			this.dataGridTableStyle1.DataGrid = this.myDataGrid1;
			this.dataGridTableStyle1.GridColumnStyles.AddRange(new System.Windows.Forms.DataGridColumnStyle[] {
																												  this.dataGridTextBoxColumn1,
																												  this.dataGridTextBoxColumn4,
																												  this.dataGridTextBoxColumn2,
																												  this.dataGridTextBoxColumn3,
																												  this.dataGridTextBoxColumn5,
																												  this.dataGridTextBoxColumn13,
																												  this.dataGridTextBoxColumn6,
																												  this.dataGridTextBoxColumn7,
																												  this.dataGridTextBoxColumn8,
																												  this.dataGridTextBoxColumn9,
																												  this.dataGridTextBoxColumn10,
																												  this.dataGridTextBoxColumn11,
																												  this.dataGridTextBoxColumn12});
			this.dataGridTableStyle1.HeaderForeColor = System.Drawing.SystemColors.ControlText;
			this.dataGridTableStyle1.MappingName = "";
			// 
			// dataGridTextBoxColumn1
			// 
			this.dataGridTextBoxColumn1.Format = "";
			this.dataGridTextBoxColumn1.FormatInfo = null;
			this.dataGridTextBoxColumn1.HeaderText = "序号";
			this.dataGridTextBoxColumn1.MappingName = "";
			this.dataGridTextBoxColumn1.ReadOnly = true;
			this.dataGridTextBoxColumn1.Width = 40;
			// 
			// dataGridTextBoxColumn4
			// 
			this.dataGridTextBoxColumn4.Format = "";
			this.dataGridTextBoxColumn4.FormatInfo = null;
			this.dataGridTextBoxColumn4.HeaderText = "货号";
			this.dataGridTextBoxColumn4.MappingName = "";
			this.dataGridTextBoxColumn4.NullText = "";
			this.dataGridTextBoxColumn4.ReadOnly = true;
			this.dataGridTextBoxColumn4.Width = 70;
			// 
			// dataGridTextBoxColumn2
			// 
			this.dataGridTextBoxColumn2.Format = "";
			this.dataGridTextBoxColumn2.FormatInfo = null;
			this.dataGridTextBoxColumn2.HeaderText = "品名";
			this.dataGridTextBoxColumn2.MappingName = "";
			this.dataGridTextBoxColumn2.NullText = "";
			this.dataGridTextBoxColumn2.ReadOnly = true;
			this.dataGridTextBoxColumn2.Width = 150;
			// 
			// dataGridTextBoxColumn3
			// 
			this.dataGridTextBoxColumn3.Format = "";
			this.dataGridTextBoxColumn3.FormatInfo = null;
			this.dataGridTextBoxColumn3.HeaderText = "商品名";
			this.dataGridTextBoxColumn3.MappingName = "";
			this.dataGridTextBoxColumn3.NullText = "";
			this.dataGridTextBoxColumn3.ReadOnly = true;
			this.dataGridTextBoxColumn3.Width = 150;
			// 
			// dataGridTextBoxColumn5
			// 
			this.dataGridTextBoxColumn5.Format = "";
			this.dataGridTextBoxColumn5.FormatInfo = null;
			this.dataGridTextBoxColumn5.HeaderText = "规格";
			this.dataGridTextBoxColumn5.MappingName = "";
			this.dataGridTextBoxColumn5.NullText = "";
			this.dataGridTextBoxColumn5.ReadOnly = true;
			this.dataGridTextBoxColumn5.Width = 70;
			// 
			// dataGridTextBoxColumn13
			// 
			this.dataGridTextBoxColumn13.Format = "";
			this.dataGridTextBoxColumn13.FormatInfo = null;
			this.dataGridTextBoxColumn13.HeaderText = "厂家";
			this.dataGridTextBoxColumn13.MappingName = "";
			this.dataGridTextBoxColumn13.NullText = "";
			this.dataGridTextBoxColumn13.Width = 70;
			// 
			// dataGridTextBoxColumn6
			// 
			this.dataGridTextBoxColumn6.Format = "";
			this.dataGridTextBoxColumn6.FormatInfo = null;
			this.dataGridTextBoxColumn6.HeaderText = "进价";
			this.dataGridTextBoxColumn6.MappingName = "";
			this.dataGridTextBoxColumn6.NullText = "";
			this.dataGridTextBoxColumn6.Width = 60;
			// 
			// dataGridTextBoxColumn7
			// 
			this.dataGridTextBoxColumn7.Format = "";
			this.dataGridTextBoxColumn7.FormatInfo = null;
			this.dataGridTextBoxColumn7.HeaderText = "批发价";
			this.dataGridTextBoxColumn7.MappingName = "";
			this.dataGridTextBoxColumn7.NullText = "";
			this.dataGridTextBoxColumn7.ReadOnly = true;
			this.dataGridTextBoxColumn7.Width = 60;
			// 
			// dataGridTextBoxColumn8
			// 
			this.dataGridTextBoxColumn8.Format = "";
			this.dataGridTextBoxColumn8.FormatInfo = null;
			this.dataGridTextBoxColumn8.HeaderText = "零售价";
			this.dataGridTextBoxColumn8.MappingName = "";
			this.dataGridTextBoxColumn8.NullText = "";
			this.dataGridTextBoxColumn8.ReadOnly = true;
			this.dataGridTextBoxColumn8.Width = 60;
			// 
			// dataGridTextBoxColumn9
			// 
			this.dataGridTextBoxColumn9.Format = "";
			this.dataGridTextBoxColumn9.FormatInfo = null;
			this.dataGridTextBoxColumn9.HeaderText = "总库存";
			this.dataGridTextBoxColumn9.MappingName = "";
			this.dataGridTextBoxColumn9.ReadOnly = true;
			this.dataGridTextBoxColumn9.Width = 60;
			// 
			// dataGridTextBoxColumn10
			// 
			this.dataGridTextBoxColumn10.Format = "";
			this.dataGridTextBoxColumn10.FormatInfo = null;
			this.dataGridTextBoxColumn10.HeaderText = "单位";
			this.dataGridTextBoxColumn10.MappingName = "";
			this.dataGridTextBoxColumn10.NullText = "";
			this.dataGridTextBoxColumn10.ReadOnly = true;
			this.dataGridTextBoxColumn10.Width = 40;
			// 
			// dataGridTextBoxColumn11
			// 
			this.dataGridTextBoxColumn11.Format = "";
			this.dataGridTextBoxColumn11.FormatInfo = null;
			this.dataGridTextBoxColumn11.HeaderText = "药库有货";
			this.dataGridTextBoxColumn11.MappingName = "";
			this.dataGridTextBoxColumn11.NullText = "";
			this.dataGridTextBoxColumn11.ReadOnly = true;
			this.dataGridTextBoxColumn11.Width = 75;
			// 
			// dataGridTextBoxColumn12
			// 
			this.dataGridTextBoxColumn12.Format = "";
			this.dataGridTextBoxColumn12.FormatInfo = null;
			this.dataGridTextBoxColumn12.HeaderText = "cjid";
			this.dataGridTextBoxColumn12.MappingName = "";
			this.dataGridTextBoxColumn12.NullText = "";
			this.dataGridTextBoxColumn12.ReadOnly = true;
			this.dataGridTextBoxColumn12.Width = 0;
			// 
			// butsave
			// 
			this.butsave.Location = new System.Drawing.Point(584, 16);
			this.butsave.Name = "butsave";
			this.butsave.Size = new System.Drawing.Size(80, 32);
			this.butsave.TabIndex = 2;
			this.butsave.Text = "保存(&S)";
			this.butsave.Click += new System.EventHandler(this.butsave_Click);
			// 
			// txtdm
			// 
			this.txtdm.Location = new System.Drawing.Point(360, 20);
			this.txtdm.Name = "txtdm";
			this.txtdm.Size = new System.Drawing.Size(128, 21);
			this.txtdm.TabIndex = 1;
			this.txtdm.Text = "";
			this.txtdm.KeyPress += new System.Windows.Forms.KeyPressEventHandler(this.txtdm_KeyPress);
			this.txtdm.KeyUp += new System.Windows.Forms.KeyEventHandler(this.txtdm_KeyUp);
			// 
			// label1
			// 
			this.label1.Location = new System.Drawing.Point(328, 24);
			this.label1.Name = "label1";
			this.label1.Size = new System.Drawing.Size(48, 16);
			this.label1.TabIndex = 0;
			this.label1.Text = "查找";
			// 
			// panel1
			// 
			this.panel1.Controls.Add(this.butcx);
			this.panel1.Controls.Add(this.button1);
			this.panel1.Controls.Add(this.chkjj);
			this.panel1.Controls.Add(this.chkkcl);
			this.panel1.Controls.Add(this.cmbyplx);
			this.panel1.Controls.Add(this.cmbjx);
			this.panel1.Controls.Add(this.chkjx);
			this.panel1.Controls.Add(this.txtdm);
			this.panel1.Controls.Add(this.label1);
			this.panel1.Controls.Add(this.butsave);
			this.panel1.Controls.Add(this.label2);
			this.panel1.Dock = System.Windows.Forms.DockStyle.Top;
			this.panel1.Location = new System.Drawing.Point(0, 0);
			this.panel1.Name = "panel1";
			this.panel1.Size = new System.Drawing.Size(768, 72);
			this.panel1.TabIndex = 5;
			// 
			// butcx
			// 
			this.butcx.Location = new System.Drawing.Point(496, 16);
			this.butcx.Name = "butcx";
			this.butcx.Size = new System.Drawing.Size(80, 32);
			this.butcx.TabIndex = 39;
			this.butcx.Text = "查询(&C)";
			this.butcx.Click += new System.EventHandler(this.butcx_Click);
			// 
			// button1
			// 
			this.button1.Location = new System.Drawing.Point(672, 16);
			this.button1.Name = "button1";
			this.button1.Size = new System.Drawing.Size(88, 32);
			this.button1.TabIndex = 38;
			this.button1.Text = "执行修改(&S)";
			this.button1.Click += new System.EventHandler(this.button1_Click);
			// 
			// chkjj
			// 
			this.chkjj.Location = new System.Drawing.Point(168, 32);
			this.chkjj.Name = "chkjj";
			this.chkjj.Size = new System.Drawing.Size(144, 24);
			this.chkjj.TabIndex = 37;
			this.chkjj.Text = "显示没有进价的药品";
			this.chkjj.CheckedChanged += new System.EventHandler(this.chkjj_CheckedChanged);
			// 
			// chkkcl
			// 
			this.chkkcl.Location = new System.Drawing.Point(168, 7);
			this.chkkcl.Name = "chkkcl";
			this.chkkcl.Size = new System.Drawing.Size(160, 24);
			this.chkkcl.TabIndex = 36;
			this.chkkcl.Text = "显示库存不为零的药品";
			this.chkkcl.CheckedChanged += new System.EventHandler(this.chkjj_CheckedChanged);
			// 
			// cmbyplx
			// 
			this.cmbyplx.DropDownStyle = System.Windows.Forms.ComboBoxStyle.DropDownList;
			this.cmbyplx.Location = new System.Drawing.Point(80, 8);
			this.cmbyplx.Name = "cmbyplx";
			this.cmbyplx.Size = new System.Drawing.Size(88, 20);
			this.cmbyplx.TabIndex = 35;
			// 
			// cmbjx
			// 
			this.cmbjx.DropDownStyle = System.Windows.Forms.ComboBoxStyle.DropDownList;
			this.cmbjx.Enabled = false;
			this.cmbjx.Location = new System.Drawing.Point(80, 40);
			this.cmbjx.Name = "cmbjx";
			this.cmbjx.Size = new System.Drawing.Size(88, 20);
			this.cmbjx.TabIndex = 33;
			// 
			// chkjx
			// 
			this.chkjx.Location = new System.Drawing.Point(8, 38);
			this.chkjx.Name = "chkjx";
			this.chkjx.Size = new System.Drawing.Size(88, 24);
			this.chkjx.TabIndex = 34;
			this.chkjx.Text = "药品剂型";
			this.chkjx.CheckedChanged += new System.EventHandler(this.chkjx_CheckedChanged);
			// 
			// label2
			// 
			this.label2.Location = new System.Drawing.Point(24, 11);
			this.label2.Name = "label2";
			this.label2.Size = new System.Drawing.Size(72, 24);
			this.label2.TabIndex = 40;
			this.label2.Text = "药品类型";
			// 
			// panel2
			// 
			this.panel2.Controls.Add(this.myDataGrid1);
			this.panel2.Dock = System.Windows.Forms.DockStyle.Fill;
			this.panel2.Location = new System.Drawing.Point(0, 72);
			this.panel2.Name = "panel2";
			this.panel2.Size = new System.Drawing.Size(768, 389);
			this.panel2.TabIndex = 6;
			// 
			// FrmJJwh
			// 
			this.AutoScaleBaseSize = new System.Drawing.Size(6, 14);
			this.ClientSize = new System.Drawing.Size(768, 485);
			this.Controls.Add(this.panel2);
			this.Controls.Add(this.panel1);
			this.Controls.Add(this.statusBar1);
			this.Name = "FrmJJwh";
			this.Text = "维护药品进货价";
			this.WindowState = System.Windows.Forms.FormWindowState.Maximized;
			this.Load += new System.EventHandler(this.Frmsccj_Load);
			this.Activated += new System.EventHandler(this.FrmJJwh_Activated);
			((System.ComponentModel.ISupportInitialize)(this.statusBarPanel1)).EndInit();
			((System.ComponentModel.ISupportInitialize)(this.statusBarPanel2)).EndInit();
			((System.ComponentModel.ISupportInitialize)(this.myDataGrid1)).EndInit();
			this.panel1.ResumeLayout(false);
			this.panel2.ResumeLayout(false);
			this.ResumeLayout(false);

		}
		#endregion

		/// <summary>
		/// 应用程序的主入口点。
		/// </summary>
		[STAThread]


		private void Frmsccj_Load(object sender, System.EventArgs e)
		{
			try
			{
				//初始化
				DataTable myTb=new DataTable();
			
				for(int i=0;i<=this.myDataGrid1.TableStyles[0].GridColumnStyles.Count-1;i++) 
				{	
					if(this.myDataGrid1.TableStyles[0].GridColumnStyles[i].GetType().ToString()=="System.Windows.Forms.DataGridBoolColumn")
						myTb.Columns.Add(this.myDataGrid1.TableStyles[0].GridColumnStyles[i].HeaderText,Type.GetType("System.Int16"));	
					else
						myTb.Columns.Add(this.myDataGrid1.TableStyles[0].GridColumnStyles[i].HeaderText,Type.GetType("System.String"));	
									   
					this.myDataGrid1.TableStyles[0].GridColumnStyles[i].MappingName=this.myDataGrid1.TableStyles[0].GridColumnStyles[i].HeaderText;
					this.myDataGrid1.TableStyles[0].GridColumnStyles[i].NullText="";
				}

//				DataRow row=myTb.NewRow();
//				row["序号"]="1";
//				myTb.Rows.Add(row);
			
				this.myDataGrid1.DataSource=myTb;
				this.myDataGrid1.TableStyles[0].MappingName ="Tb";

				

			}
			catch(System.Exception err)
			{
				MessageBox.Show("发生错误"+err.Message);
			}
		}


		private void butcx_Click(object sender, System.EventArgs e)
		{
			try
			{

				DataTable tb=new DataTable("Tb");
				string ssql="select * from ( select 0  序号,shh 货号,yppm 品名,ypspm 商品名,ypgg 规格,s_sccj 厂家,"+
					"(case when (select top 1 cjid from yk_kcmx where cjid=a.cjid) is null then (select top 1 scjj from yf_kcmx where cjid=a.cjid order by scjj desc) else (select top 1 scjj from yk_kcmx where cjid=a.cjid order by scjj desc) end) 进价,"+
					" pfj 批发价,lsj 零售价,"+
					" cast(sum(kcl/dwbl) as decimal(12,3)) 总库存,dbo.fun_yp_ypdw(ypdw) 单位,(case when coalesce((select top 1 cjid from yk_kcmx where cjid=a.cjid),0)=0 then '' else '是' end) 药库有货"+
					" ,cjid from "+
					" (select * from vi_yk_kcmx union all select * from vi_Yf_kcmx) a where deptid<>0  and cjid in(select cjid from yk_kcph where jhj=0 union select cjid from yf_kcph where jhj=0)";
			
				ssql=ssql+" and yplx="+Convert.ToInt32(Convertor.IsNull(cmbyplx.SelectedValue,"0"))+" ";
				if (chkjx.Checked==true) ssql=ssql+" and ypjx="+Convert.ToInt32(Convertor.IsNull(cmbjx.SelectedValue,"0"))+" ";
			
				if (txtdm.Text.Trim()!="")
				{
					ssql=ssql+" and ggid in(select ggid from yp_ypbm where upper(pym) like '"+txtdm.Text.Trim().ToUpper()+"%' or upper(wbm) like '"+txtdm.Text.Trim().ToUpper()+"%'"+
						" or upper(szm) like '"+txtdm.Text.Trim().ToUpper()+"%' or ypbm like '%"+txtdm.Text.Trim()+"%')";
				}

				ssql=ssql+" group by shh,yppm,ypspm,ypgg,s_sccj,pfj,lsj,ypdw,cjid ) aa where cjid>0 ";

				if (chkkcl.Checked==true) 
				{
					ssql=ssql+" and 总库存<>0";
				}

				if (chkjj.Checked==true) 
				{
					ssql=ssql+" and  进价=0";
				}

				tb=InstanceForm.BDatabase.GetDataTable(ssql);
				FunBase.AddRowtNo(tb);
				tb.TableName="Tb";
				this.myDataGrid1.DataSource=tb;
				this.myDataGrid1.TableStyles[0].MappingName="Tb";

			}
			catch(System.Exception err)
			{
				MessageBox.Show("对不起,发生错误"+err.Message );
			}
		}

		private void cmbyplx_SelectedIndexChanged(object sender, System.EventArgs e)
		{
			Yp.AddcmbYpjx(Convert.ToInt32(Convertor.IsNull(cmbyplx.SelectedValue,"0")),this.cmbjx, InstanceForm.BDatabase);
		}

		private void chkjx_CheckedChanged(object sender, System.EventArgs e)
		{
			cmbjx.Enabled=chkjx.Checked==true?true:false;
						Yp.AddcmbYpjx(Convert.ToInt32(Convertor.IsNull(cmbyplx.SelectedValue,"0")),this.cmbjx, InstanceForm.BDatabase);
		}

		private void txtdm_KeyUp(object sender, System.Windows.Forms.KeyEventArgs e)
		{
			this.butcx_Click(sender,e);
		}

		private void txtdm_KeyPress(object sender, System.Windows.Forms.KeyPressEventArgs e)
		{
		
		}

		private void chkjj_CheckedChanged(object sender, System.EventArgs e)
		{
			this.butcx_Click(sender,e);
		}

		private void FrmJJwh_Activated(object sender, System.EventArgs e)
		{
            Yp.AddCmbYplx(false, InstanceForm.BCurrentDept.DeptId, this.cmbyplx, InstanceForm.BDatabase);
		}

		private void butsave_Click(object sender, System.EventArgs e)
		{
			string ssql="";
			DataTable tb=(DataTable)this.myDataGrid1.DataSource;

			try
			{
				InstanceForm.BDatabase.BeginTransaction();
				for(int i=0;i<=tb.Rows.Count-1;i++)
				{
					if (Convertor.IsNumeric(tb.Rows[i]["进价"].ToString())==false && tb.Rows[i]["进价"].ToString().Trim()!="" )
						throw new Exception("请在进价处输入数字");
					decimal jhj=Convert.ToDecimal(tb.Rows[i]["进价"]);
					//if (tb.Rows[i]["药库有货"].ToString().Trim()=="是")
					ssql="update yk_kcmx set scjj="+jhj+" where cjid="+Convert.ToInt32(tb.Rows[i]["cjid"])+"";
					InstanceForm.BDatabase.DoCommand(ssql);
					//else
					ssql="update yf_kcmx set scjj="+jhj+" where cjid="+Convert.ToInt32(tb.Rows[i]["cjid"])+"";
					InstanceForm.BDatabase.DoCommand(ssql);
				}
				InstanceForm.BDatabase.CommitTransaction();
				MessageBox.Show("保存成功","保存",MessageBoxButtons.OK,MessageBoxIcon.Information);
			}
			catch(System.Exception err)
			{
				InstanceForm.BDatabase.RollbackTransaction();
				MessageBox.Show(err.Message);
			}

		}

		private void button1_Click(object sender, System.EventArgs e)
		{
			string ssql="";
			DataTable tb=(DataTable)this.myDataGrid1.DataSource;

			if(MessageBox.Show("此操作将更新所有库房中药品的进货价，请您认真核对进价后再执行此操作，您确定要执行吗？","询问窗",MessageBoxButtons.YesNo,MessageBoxIcon.Question,MessageBoxDefaultButton.Button2)==DialogResult.No)
			return;

			try
			{
				InstanceForm.BDatabase.BeginTransaction();
				for(int i=0;i<=tb.Rows.Count-1;i++)
				{
					if (Convertor.IsNumeric(tb.Rows[i]["进价"].ToString())==false && tb.Rows[i]["进价"].ToString().Trim()!="" )
						throw new Exception("请在第"+i.ToString()+"行的进价处输入数字");
					decimal jhj=Convert.ToDecimal(tb.Rows[i]["进价"]);
					
					if (jhj>0)
					{
						ssql="update yk_kcph set jhj="+jhj+" where cjid="+Convert.ToInt32(tb.Rows[i]["cjid"])+"";
						InstanceForm.BDatabase.DoCommand(ssql);

						ssql="update yf_kcph set jhj="+jhj+" where cjid="+Convert.ToInt32(tb.Rows[i]["cjid"])+"";
						InstanceForm.BDatabase.DoCommand(ssql);
					}
				}
				InstanceForm.BDatabase.CommitTransaction();
				MessageBox.Show("操作成功","执行修改",MessageBoxButtons.OK,MessageBoxIcon.Information);
			}
			catch(System.Exception err)
			{
				InstanceForm.BDatabase.RollbackTransaction();
				MessageBox.Show(err.Message);
			}
		}


	}
}
